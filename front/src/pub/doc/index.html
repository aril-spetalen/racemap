<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
      <title>Seilaskart</title>

      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin="">
      </script>
      <link rel="stylesheet" type="text/css" href="race.css" media="screen" />
  </head>

  <body>

    <div id="map"></div>
    <script src="maplogic.js">
    </script>

    <!-- form onSubmit="return query()" -->
    <form>
      <div>
        <label for="search">Søk etter regattaer</label>
        <input id="raceQuery" 
               type="search"
               onsearch="performSearch()"
               name="querystring"
               value="færderseilasen">
      </div>
      <div>
        <input id="searchButton"
               type="button" 
               value="Søk" 
               accesskey="s">
      </div>
    </form>
    <div id='response'>
    </div>
    <script>
          var queryInput = document.querySelector('input#raceQuery');
          var searchButton = document.querySelector('input#searchButton');
          var searchResult = document.querySelector('#response');
    
          function performSearch(query) {
            // build the querystring
            esQuery = JSON.stringify({"query": query});
            const url = 'query_handler';
            console.log('post to query_handler the following query:', esQuery);
    
            fetch(url, {
              method: 'POST',
              headers:{'content-type': 'application/json'},
              body: esQuery
            }).then(function(response) {
              response.json().then((data) => {
                searchResult.textContent = JSON.stringify(data);
                console.log("typeof data:", typeof(data));
                console.log("data.hits:", data.hits);
                let races = data.hits.hits;
                races.forEach(race => {
                  console.log(race._source.coordinates.coordinate);
                  var m = L.marker([race._source.coordinates.coordinate.lat, race._source.coordinates.coordinate.lon]);
                  m.bindPopup(`<b>${race._source.name}</b><br>${race._source.clubName}<br><a href=\"https:\/\/manage2sail.com${race._source.link}\">${race._source.name}</a>`).openPopup();
                  m.addTo(map);
                });
              });
            });
          };
    
          window.addEventListener('keydown',function(e) {
            if(e.keyIdentifier=='U+000A' || e.keyIdentifier=='Enter' || e.keyCode==13) {
              if(e.target.nodeName=='INPUT' && e.target.type=='search') {
                e.preventDefault();
                return false;
              }
            }
          }, true);
          // queryInput.onsearch = ( () => {
          //   var query = queryInput.value;
          //   performSearch(query);
          // });
          searchButton.onclick = ( () => {
            var query = queryInput.value;
            performSearch(query);
          })
    
         // performSearch('cup');
          // queryInput.value = 'cup';
          // searchButton.click();
    
        </script>


  </body>
</html>

